<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THEYAR - Persistent Guild System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: 'Inter', sans-serif; }
        
        /* Hiệu ứng phân cấp Grade */
        .grade-s { border: 2px solid #fbbf24; box-shadow: 0 0 25px rgba(251, 191, 36, 0.3); background: linear-gradient(145deg, #1e1b00, #0f172a); }
        .grade-a { border: 2px solid #a855f7; box-shadow: 0 0 20px rgba(168, 85, 247, 0.2); background: linear-gradient(145deg, #16002e, #0f172a); }
        .grade-b { border: 1px solid #3b82f6; background: #0f172a; }
        
        #adminSection { display: none; }
        .top-card { transform: scale(1.05); z-index: 10; border-width: 3px !important; }
        .medal-icon { position: absolute; top: -15px; right: -10px; font-size: 2.5rem; transform: rotate(15deg); }
        .cursor-edit { border-bottom: 1px dashed #fbbf24; cursor: pointer; }
        
        /* Loading animation */
        .sync-status { font-size: 0.7rem; color: #10b981; display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <nav class="flex justify-between items-center mb-10 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 sticky top-4 z-50">
            <div class="flex items-center gap-3">
                <div id="statusDot" class="w-3 h-3 rounded-full bg-slate-500"></div>
                <div>
                    <span id="userStatus" class="text-xs font-bold uppercase tracking-widest text-slate-500">Chế độ: Viewer</span>
                    <p id="syncMsg" class="sync-status"><i class="fas fa-check-circle"></i> Đã đồng bộ bộ nhớ</p>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button id="authBtn" onclick="handleAuth()" class="bg-slate-800 hover:bg-slate-700 px-5 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2">
                    <i id="authIcon" class="fas fa-user-shield"></i> <span id="authText">XÁC MINH ADMIN</span>
                </button>

                <div id="adminSection" class="flex gap-2">
                    <label class="bg-yellow-600 hover:bg-yellow-500 text-black px-5 py-2 rounded-xl cursor-pointer text-xs font-bold transition-all flex items-center gap-2 shadow-lg">
                        <i class="fas fa-file-upload"></i> NHẬP MỚI
                        <input type="file" id="excelInput" class="hidden" accept=".xlsx, .xls, .csv">
                    </label>
                    <button onclick="clearData()" class="bg-red-900/50 hover:bg-red-600 text-white px-3 py-2 rounded-xl text-xs transition-all">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </nav>

        <header class="mb-12">
            <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-500 to-yellow-600 uppercase tracking-tighter">THEYAR HALL OF FAME</h1>
            <p class="text-slate-500 text-sm mt-2 font-medium">Hệ thống lưu trữ dữ liệu tự động trên trình duyệt.</p>
        </header>

        <div class="mb-12 relative">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
            <input type="text" id="searchInput" onkeyup="search()" placeholder="Tìm tên hội, hội trưởng hoặc hội phó..." 
                   class="w-full bg-slate-900 border border-slate-800 p-4 pl-12 rounded-2xl focus:outline-none focus:border-yellow-500 transition-all">
        </div>

        <div id="hallOfFame" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16"></div>

        <hr class="border-slate-800 mb-12">

        <div id="guildList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </div>

    <script>
        let fullData = [];
        let isAdmin = false;

        // 1. KHỞI TẠO: Tải dữ liệu từ LocalStorage khi mở trang
        window.onload = function() {
            const savedData = localStorage.getItem('theyar_guild_data');
            if (savedData) {
                fullData = JSON.parse(savedData);
                renderWeb();
                document.getElementById('syncMsg').style.display = 'block';
            }
            isAdmin = false;
            document.getElementById('adminSection').style.display = 'none';
        };

        // 2. XÁC THỰC
        function handleAuth() {
            if (!isAdmin) {
                const answer = prompt("Bạn có tin vào chúa không ?");
                if (answer && answer.trim().toLowerCase() === "tucu") {
                    isAdmin = true;
                    updateUIAdmin();
                } else {
                    alert("Sai mật mã. Quyền Viewer được giữ nguyên.");
                }
            } else {
                if(confirm("Thoát chế độ Admin?")) location.reload();
            }
        }

        function updateUIAdmin() {
            document.getElementById('adminSection').style.display = 'flex';
            document.getElementById('statusDot').classList.replace('bg-slate-500', 'bg-yellow-500');
            document.getElementById('userStatus').innerText = "Chế độ: Admin";
            document.getElementById('userStatus').classList.replace('text-slate-500', 'text-yellow-500');
            document.getElementById('authText').innerText = "ĐĂNG XUẤT";
            document.getElementById('authBtn').classList.add('bg-yellow-500', 'text-black');
            renderWeb();
        }

        // 3. XỬ LÝ DỮ LIỆU & LƯU TRỮ
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Sắp xếp theo Rank mùa
                fullData = XLSX.utils.sheet_to_json(sheet).sort((a, b) => a["RANK mùa"] - b["RANK mùa"]);
                
                // LƯU VÀO LOCALSTORAGE
                saveToLocal();
                renderWeb();
            };
            reader.readAsArrayBuffer(file);
        });

        function saveToLocal() {
            localStorage.setItem('theyar_guild_data', JSON.stringify(fullData));
            document.getElementById('syncMsg').style.display = 'block';
        }

        function clearData() {
            if(confirm("Xóa toàn bộ dữ liệu đã lưu?")) {
                localStorage.removeItem('theyar_guild_data');
                fullData = [];
                renderWeb();
                alert("Đã xóa bộ nhớ đệm.");
            }
        }

        function editField(index, field) {
            if (!isAdmin) return;
            const newValue = prompt(`Chỉnh sửa ${field}:`, fullData[index][field]);
            if (newValue !== null) {
                fullData[index][field] = newValue;
                saveToLocal(); // Lưu lại ngay sau khi sửa
                renderWeb();
            }
        }

        // 4. RENDER UI
        function createCard(item, idx, isTop = false, topRank = 0) {
            const grade = item["Cấp"] || "";
            let gradeClass = 'grade-b';
            if (grade.includes('S')) gradeClass = 'grade-s';
            else if (grade.includes('A')) gradeClass = 'grade-a';

            let medal = "";
            if (topRank === 1) medal = '<i class="fas fa-medal text-yellow-400 medal-icon"></i>';
            if (topRank === 2) medal = '<i class="fas fa-medal text-slate-300 medal-icon"></i>';
            if (topRank === 3) medal = '<i class="fas fa-medal text-orange-400 medal-icon"></i>';

            const editStyle = isAdmin ? 'cursor-edit' : '';

            return `
                <div class="guild-card ${gradeClass} ${isTop ? 'top-card p-8' : 'p-6'} rounded-3xl relative transition-all duration-300">
                    ${medal}
                    <div class="mb-4">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Rank ${item["RANK mùa"]}</p>
                        <h3 class="${isTop ? 'text-2xl' : 'text-lg'} font-black text-white truncate ${editStyle}" 
                            onclick="editField(${idx}, 'Tên hội in game')">
                            ${item["Tên hội in game"] || "N/A"}
                        </h3>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 bg-white/5 p-2.5 rounded-xl transition-colors ${isAdmin ? 'hover:bg-white/10' : ''}" onclick="editField(${idx}, 'Hội trưởng')">
                            <i class="fas fa-crown text-yellow-500 text-sm"></i>
                            <span class="text-sm text-slate-200 truncate font-semibold ${editStyle}">${item["Hội trưởng"] || "N/A"}</span>
                        </div>
                        <div class="flex items-center gap-3 bg-white/5 p-2.5 rounded-xl transition-colors ${isAdmin ? 'hover:bg-white/10' : ''}" onclick="editField(${idx}, 'hội phó')">
                            <i class="fas fa-user-shield text-blue-400 text-sm"></i>
                            <span class="text-sm text-slate-200 truncate font-semibold ${editStyle}">${item["hội phó"] || "N/A"}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWeb(data = fullData) {
            const topContainer = document.getElementById('hallOfFame');
            const restContainer = document.getElementById('guildList');
            topContainer.innerHTML = '';
            restContainer.innerHTML = '';
            if(!data || data.length === 0) {
                restContainer.innerHTML = '<p class="col-span-full text-center text-slate-600 py-10 italic">Chưa có dữ liệu hội. Admin hãy nhập file Excel.</p>';
                return;
            }
            data.slice(0, 3).forEach((item, i) => topContainer.innerHTML += createCard(item, i, true, i + 1));
            data.slice(3).forEach((item, i) => restContainer.innerHTML += createCard(item, i + 3));
        }

        function search() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = fullData.filter(g => 
                (g["Tên hội in game"]?.toLowerCase().includes(q)) || 
                (g["Hội trưởng"]?.toLowerCase().includes(q)) ||
                (g["hội phó"]?.toLowerCase().includes(q))
            );
            renderWeb(filtered);
        }
    </script>
</body>
</html>